#### Домашнее задание Работа с журналами
* 1) Настройте выполнение контрольной точки раз в 30 секунд.
 В файле конфигурации postgresql.conf установить параметр checkpoint_timeout = 30s и перезагрузить postgresql
 
* 2) 10 минут c помощью утилиты pgbench подавайте нагрузку.
 pgbench -U postgres -c 150 -j 2 -P 60 -T 600 test
 **Результат:**
starting vacuum...end.
progress: 60.0 s, 2209.4 tps, lat 67.022 ms stddev 109.573, 0 failed
progress: 120.0 s, 2234.2 tps, lat 67.206 ms stddev 113.515, 0 failed
progress: 180.0 s, 2236.9 tps, lat 67.028 ms stddev 116.254, 0 failed
progress: 240.0 s, 2246.9 tps, lat 66.767 ms stddev 117.452, 0 failed
progress: 300.0 s, 2208.9 tps, lat 67.883 ms stddev 108.513, 0 failed
progress: 360.0 s, 2211.6 tps, lat 67.860 ms stddev 116.054, 0 failed
progress: 420.0 s, 2245.7 tps, lat 66.777 ms stddev 112.825, 0 failed
progress: 480.0 s, 2269.3 tps, lat 66.081 ms stddev 110.521, 0 failed
progress: 540.0 s, 2247.2 tps, lat 66.757 ms stddev 117.363, 0 failed
progress: 600.0 s, 2258.4 tps, lat 66.397 ms stddev 111.915, 0 failed
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 150
number of threads: 2
maximum number of tries: 1
duration: 600 s
number of transactions actually processed: 1342262
number of failed transactions: 0 (0.000%)
latency average = 66.988 ms
latency stddev = 113.466 ms
initial connection time = 594.079 ms
tps = 2238.980147 (without initial connection time)

* 3) Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку. 
 pg_lsclusters - посмотреть путь
 du -sh /path/to/your/data/directory/pg_wal - определить объем журналов WAL
 113M
 в логе по пути /var/log/postgresql/postgresql-17-main.log указано выполнение 16 точек:
 checkpoint complete: wrote 3560 buffers (0.3%); 0 WAL file(s) added, 0 removed, 3 recycled; write=27.067 s, sync=0.004 s, total=27.077 s; sync files=19, longest=0.002 s, average=0.001 s; distance=49930 kB, estimate=50401 kB; lsn=0/27777058, redo lsn=0/24A55678

* 4) Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. **Почему так произошло?**
 Не все точки были выполнены по расписанию, т.к. предыдущие выполнялись более 30 секунд, и начало выполнения началось немного позже выполнения теста, по этому их не ровно 20 как можно предположить.
 
* 5) Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат. 
 синхронный режим: tps = 2238.980147
 асинхронный режим: tps = 4506.018699 (Быстрее в 2 раза)
 В асинхронном режиме сервер не ждёт, пока информация будет записана на диск, чтобы отправить подтверждение, что позволяет работать быстрее, но может привести к потере данных, если что-то пойдёт не так до того, как информация будет записана на диск.

* 6) Создайте новый кластер с включенной контрольной суммой страниц.
 pg_createcluster 17 Prod -p 5444 -- --data-checksums
 pg_ctlcluster 17 Prod restart - перезапуск отдельного сервера в кластере
 Создайте таблицу.
 psql -U postgres -p 5454 -c "create table test(message text)"
 Вставьте несколько значений. 
 "insert into test (message) values ('123')"
 "insert into test (message) values ('321')"
 "SELECT pg_relation_filepath('test');" - узнать id таблицы
 base/5/16388
 Выключите кластер.
 pg_ctlcluster 17 Prod stop
 Измените пару байт в таблице.
 Включите кластер и сделайте выборку из таблицы.
 pg_ctlcluster 17 Prod start
 "select * from test"
 Что и почему произошло?
 **Получил ошибку:**
 WARNING:  page verification failed, calculated checksum 13283 but expected 8664
 ERROR:  invalid page in block 0 of relation base/5/16388
 потому что checksum гарантирует целостность данных, а я их изменил.
 **Как проигнорировать ошибку и продолжить работу?**
 Выполнить полный вакуум
 vacuum full
 ________________________
 Скрипкин А.В.
 
 





 
 
 
