#### Домашнее задание Триггеры, поддержка заполнения витрин

* 1) Создать триггер (на таблице sales) для поддержки данных витрины good_sum_mart

* Если создавать триггер с  DECLARE (используется для создания переменных), то получим ошибку (syntax error at or near "DECLARE"), для корректной работы нужно создать функцию обработчик:
 >>
 CREATE OR REPLACE FUNCTION trg_sales_to_good_sum_mart()  
 RETURNS TRIGGER AS $$  
 DECLARE  
    v_total_quantity INTEGER;  
    v_total_sales NUMERIC;  
 BEGIN  
    IF (TG_OP = 'INSERT') THEN  
        -- Пересчитываем сумму по продукту после вставки  
        SELECT COALESCE(SUM(quantity), 0), COALESCE(SUM(quantity * price), 0)  
        INTO v_total_quantity, v_total_sales  
        FROM sales WHERE product_id = NEW.product_id;  

        INSERT INTO good_sum_mart (product_id, total_quantity, total_sales)  
        VALUES (NEW.product_id, v_total_quantity, v_total_sales)  
        ON CONFLICT (product_id) DO UPDATE SET  
            total_quantity = EXCLUDED.total_quantity,  
            total_sales = EXCLUDED.total_sales;  

    ELSIF (TG_OP = 'UPDATE') THEN  
        -- Пересчитываем сумму после обновления  
        SELECT COALESCE(SUM(quantity), 0), COALESCE(SUM(quantity * price), 0)  
        INTO v_total_quantity, v_total_sales
        FROM sales WHERE product_id = NEW.product_id;

        UPDATE good_sum_mart SET
            total_quantity = v_total_quantity,
            total_sales = v_total_sales
        WHERE product_id = NEW.product_id;

    ELSIF (TG_OP = 'DELETE') THEN
        -- Пересчитываем сумму после удаления
        SELECT COALESCE(SUM(quantity), 0), COALESCE(SUM(quantity * price), 0)
        INTO v_total_quantity, v_total_sales
        FROM sales WHERE product_id = OLD.product_id;

        IF v_total_quantity > 0 THEN
            UPDATE good_sum_mart SET
                total_quantity = v_total_quantity,
                total_sales = v_total_sales
            WHERE product_id = OLD.product_id;
        ELSE
            DELETE FROM good_sum_mart WHERE product_id = OLD.product_id;
        END IF;
    END IF;

    RETURN NULL; -- Триггер не возвращает измененную строку
 END;
 $$ LANGUAGE plpgsql;
 
* Создаем триггер: 
 >>
 CREATE TRIGGER trg_sales_update_good_sum_mart  
 AFTER INSERT OR UPDATE OR DELETE ON sales  
 FOR EACH ROW EXECUTE FUNCTION trg_sales_to_good_sum_mart();
 ______________
 Скрипкин А.В.